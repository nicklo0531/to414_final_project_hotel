---
title: "testtest"
output: html_document
---

```{r}
setwd("../")
source("data/data_cleaning_splitting.R")

library(e1071)
library(caret)
library(pROC)
set.seed(12345)

# Ensure factors with consistent levels
df_train$is_canceled <- factor(df_train$is_canceled, levels = c(0,1))
df_test$is_canceled  <- factor(df_test$is_canceled,  levels = c(0,1))

kernels <- c("linear", "radial", "sigmoid")
svm_results <- list()
svm_aucs <- c()

comparison_rows <- list()   # will store comparison table rows

for (k in kernels) {
  
  svm_model <- svm(
    is_canceled ~ .,
    data = df_train,
    kernel = k,
    probability = TRUE
  )
  
  # Predictions on test
  pred_class <- predict(svm_model, df_test)
  pred_class <- factor(pred_class, levels = c(0,1))
  
  prob_obj <- predict(svm_model, df_test, probability = TRUE)
  pred_prob <- attr(prob_obj, "probabilities")[, "1"]
  
  # Save linear kernel outputs for stacking
  if (k == "linear") {
    saveRDS(svm_model, "RDS/svm_linear_model.rds")
    train_prob_lin <- attr(predict(svm_model, df_train, probability = TRUE), "probabilities")[, "1"]
    saveRDS(train_prob_lin, "RDS/svm_linear_train_prob.rds")
    saveRDS(pred_prob,      "RDS/svm_linear_test_prob.rds")
  }
  
  # Save train probs for all kernels
  train_prob <- attr(predict(svm_model, df_train, probability = TRUE), "probabilities")[, "1"]
  saveRDS(train_prob, paste0("RDS/svm_", k, "_train_prob.rds"))
  
  # Metrics
  cm <- confusionMatrix(pred_class, df_test$is_canceled, positive = "1")
  roc_obj <- roc(df_test$is_canceled, pred_prob)
  auc_val <- auc(roc_obj)
  
  svm_results[[k]] <- cm
  svm_aucs[k] <- auc_val
  
  # Build comparison table row
  comparison_rows[[k]] <- data.frame(
    Kernel      = k,
    AUC         = auc_val,
    Accuracy    = cm$overall["Accuracy"],
    Kappa       = cm$overall["Kappa"],
    Sensitivity = cm$byClass["Sensitivity"],
    Specificity = cm$byClass["Specificity"]
  )
}

# Combine all comparison rows
svm_comparison <- do.call(rbind, comparison_rows)

# Determine the best kernel by max AUC
best_kernel <- svm_comparison$Kernel[which.max(svm_comparison$Kappa)]
best_cm <- svm_results[[best_kernel]]

# Print outputs
print("SVM Kernel Comparison Table")
print(svm_comparison)

cat("\n Best Kernel (highest Kappa):", best_kernel, "\n")
print(best_cm)
```

